#############################
#############################
#############################
#non-www to www for envelopes
server {
    listen 80;
    listen [::]:80;
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name envelopes.com;
    #set ssl rules
    include /usr/local/ofbiz/etc/nginx/envelopes_ssl.rules;
    include /usr/local/ofbiz/etc/nginx/ssl.rules;

    return 301 https://www.envelopes.com$request_uri;
}

#origin.envelopes.com
server {
    error_log                  /var/log/nginx/error.log;
    access_log                 /var/log/nginx/access.log main;
    client_max_body_size       5M;

    listen 80;
    listen [::]:80;
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name                origin.envelopes.com;
    #set ssl rules
    include /usr/local/ofbiz/etc/nginx/envelopes_ssl.rules;
    include /usr/local/ofbiz/etc/nginx/ssl.rules;

    location / {
        deny all;
    }
}

#route http to https for www.envelopes.com
server {
    listen 80;
    listen [::]:80 ipv6only=on;

    server_name    www.envelopes.com;
    return         301 https://www.envelopes.com$request_uri;
}

#############################
#pps.envelopes.com to os.bigname.com
server {
    listen 80;
    listen [::]:80;
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name pps.envelopes.com;
    #set ssl rules
    include /usr/local/ofbiz/etc/nginx/envelopes_ssl.rules;
    include /usr/local/ofbiz/etc/nginx/ssl.rules;

    return 301 https://os.bigname.com$request_uri;
}

#www.envelopes.com
server {
    error_log                  /var/log/nginx/error.log;
    access_log                 /var/log/nginx/access.log main;
    client_max_body_size       60M;

    listen 443 ssl http2;
    listen [::]:443 ipv6only=on ssl http2;

    server_name                localhost www.envelopes.com;

    #set ssl rules
    include /usr/local/ofbiz/etc/nginx/envelopes_ssl.rules;
    include /usr/local/ofbiz/etc/nginx/ssl.rules;

    #set gzip to reduce transfer sizes
    include /usr/local/ofbiz/etc/nginx/gzip.rules;

    if ($scheme = http) {
        set $ofbiz $scheme://serverfarm;
    }
    if ($scheme = https) {
        set $ofbiz $scheme://serverfarmSecure;
    }
    if ($newRedirect) {
        rewrite ^ $newRedirect? permanent; #ignore query params
    }
    if ($new) {
        set $ofbiz $ofbiz$new$is_args$args;
    }

    #404
    error_page                 404 /404.html;
    location = /404.html {
        root /usr/local/ofbiz/hot-deploy/html/webapp/html/404;
    }

    location = /robots.txt {
        alias /usr/local/ofbiz/hot-deploy/html/webapp/html/robots.txt;
    }

    location = /sitemap.xml {
        alias /usr/local/ofbiz/hot-deploy/html/webapp/html/sitemap.xml;
    }

    location = /rss {
        alias /usr/local/ofbiz/hot-deploy/html/webapp/html/feeds/rss-feed.xml;
    }

    #old image links to new image links
    location ~* ^/images/products/.*/(.*).jpg$ {
        set $prodImg $1;
        rewrite_by_lua 'return ngx.redirect("http://actionenvelope.scene7.com/is/image/ActionEnvelope/" .. ngx.var.prodImg .. "?hei=700&fmt=jpeg&ts=10239123", ngx.HTTP_MOVED_PERMANENTLY)';
    }

    #scene7 design images for google
    location ~* ^/images/designs/.*/(.*).jpg$ {
        set $designImg $1;
        rewrite_by_lua 'return ngx.redirect("http://actionenvelopew2p.scene7.com/is/agm/ActionEnvelope/" .. ngx.var.designImg .. "?hei=700&fmt=jpeg&ts=10239123", ngx.HTTP_MOVED_PERMANENTLY)';
    }

    #cors rules
    include /usr/local/ofbiz/etc/nginx/cors.rules;

    #set caching for static files
    include /usr/local/ofbiz/etc/nginx/static.rules;

    #block random requests to bad urls
    location ~* /<\@ofbizContentUrl> {
        return 403;
    }

    #update ae urls
    location ~* /ae/control/ {
        rewrite ^(.*)/ae/control/(.*)$ $scheme://$host$1/envelopes/control/$2 permanent;
    }

    #update folders urls
    location ~* /folders/control/ {
        rewrite ^(.*)/folders/control/(.*)$ https://www.folders.com/folders/control/$2 permanent;
    }

    #cache rules
    include /usr/local/ofbiz/etc/nginx/cache.rules;

    #main rules
    location / {
        add_header Cache-Control "no-cache";

        proxy_pass $ofbiz;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Cache $cache;
        proxy_redirect off;
        proxy_intercept_errors on;
        proxy_http_version 1.1;

        #health_check interval=2m fails=2 passes=2 uri=/envelopes/control/healthCheck match=server_ok;
    }

    location = /blog {
        return 301 $scheme://$host/blog/;
    }

    location /blog/ {
        root /usr/local/;
        index index.php;
        add_header Cache-Control "public";
        expires 1M;
        access_log off;
        autoindex off;
        try_files $uri $uri/ /blog/index.php?q=$uri&$args;
    }

    location ~ /blog.*?\.php$ {
        root /usr/local/;
        index index.php;
        #fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/var/run/php/php7.0-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_index index.php;
        include fastcgi_params;
    }

    location /blog/wp-content/themes/Divi/core/admin/fonts/ {
        deny all;
    }

    location ~ \/trade\/[a-zA-Z0-9]+(?:\/|)$ {
        rewrite \/trade\/([a-zA-Z0-9]+) /tradepro?c=$1 redirect;
    }

    location ~* /bigname/control/ {
        return 404;
    }

    location ~* /bags/control/ {
        return 404;
    }
}

#envelopes.envelopes.com
server {
    error_log                  /var/log/nginx/error.log;
    access_log                 /var/log/nginx/access.log main;
    client_max_body_size       20M;

    listen 80;
    listen [::]:80;

    server_name                envelopes.envelopes.com;

    #set gzip to reduce transfer sizes
    include /usr/local/ofbiz/etc/nginx/gzip.rules;

    if ($sliRedirect) {
        rewrite ^ $sliRedirect? permanent; #ignore query params
    }

    location ~ ^/envelopes/(.*)$ {
        set $sliPath $1;
        rewrite_by_lua '
            ngx.var.sliPath = ngx.re.gsub(ngx.var.sliPath, "-", " ")
            return ngx.redirect("https://www.envelopes.com/envelopes/control/search?w=" .. ngx.var.sliPath, ngx.HTTP_MOVED_PERMANENTLY)
        ';
    }

    location ~ ^/products/(.*)$ {
        set $sliPath $1;
        rewrite_by_lua '
            ngx.var.sliPath = ngx.re.gsub(ngx.var.sliPath, "-", " ")
            return ngx.redirect("https://www.envelopes.com/envelopes/control/search?w=" .. ngx.var.sliPath, ngx.HTTP_MOVED_PERMANENTLY)
        ';
    }
}

#static.envelopemedia.com
server {
    error_log                  /var/log/nginx/error.log;
    access_log                 /var/log/nginx/access.log main;
    client_max_body_size       60M;

    listen 80;
    listen [::]:80;
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name                static.envelopemedia.com cdn.envelopemedia.com ddsgqx4ae3i18.cloudfront.net;
    #set ssl rules
    include /usr/local/ofbiz/etc/nginx/envelopes_ssl.rules;
    include /usr/local/ofbiz/etc/nginx/ssl.rules;

    #set gzip to reduce transfer sizes
    include /usr/local/ofbiz/etc/nginx/gzip.rules;

    location = /robots.txt {
        alias /usr/local/ofbiz/hot-deploy/html/webapp/html/robots.txt;
    }

    #set caching for static files
    include /usr/local/ofbiz/etc/nginx/static.rules;
}