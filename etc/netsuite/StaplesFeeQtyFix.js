var nsp_orders = { "TV9482": "X", "TV9482": "X", "UB9922": "X", "UG2643": "X", "UG2650": "X", "UK3414": "X", "UO0964": "X", "UO6574": "X", "UT6912": "X", "UV0139": "X", "UX1293": "X", "UX2110": "X", "UX2111": "X", "UX4322": "X", "UX4340": "X", "UX7811": "X", "UZ4680": "X", "V02501": "X", "VF2640": "X", "VH9713": "X", "UZ4680": "X", "V02501": "X", "VF2640": "X", "VH9713": "X", "VI5429": "X", "VJ3714": "X", "VJ3715": "X", "VL9433": "X", "VN3985": "X", "VN4237": "X", "VN5953": "X", "VN8312": "X", "vn8313": "X", "VN9279": "X", "VO2497": "X", "VO2498": "X", "VO2499": "X", "VO2502": "X", "VO2503": "X", "VO2504": "X", "VO3456": "X", "VO3675": "X", "VO4410": "X", "VO4411": "X", "VO4986": "X", "VO2499": "X", "VO2502": "X", "VO2503": "X", "VO2504": "X", "VO3456": "X", "VO3675": "X", "VO4410": "X", "VO4411": "X", "VO4986": "X", "VO5301": "X", "VO7385": "X", "VO8304": "X", "VO8414": "X", "VO8415": "X", "VO8678": "X", "VO8680": "X", "VP0989": "X", "VP0990": "X", "VP0991": "X", "VP0993": "X", "VP0994": "X", "VP0995": "X", "VP2087": "X", "VP2087": "X", "VQ1880": "X", "VO8304": "X", "VO8414": "X", "VO8415": "X", "VO8678": "X", "VO8680": "X", "VP0989": "X", "VP0990": "X", "VP0991": "X", "VP0993": "X", "VP0994": "X", "VP0995": "X", "VP2087": "X", "VP2087": "X", "VQ1880": "X", "VQ1881": "X", "VQ1882": "X", "VQ1883": "X", "VQ1884": "X", "VQ1885": "X", "VQ1886": "X", "VQ1887": "X", "VQ1888": "X", "VQ1890": "X", "VQ3283": "X", "VQ3284": "X", "VQ1884": "X", "VQ1885": "X", "VQ1886": "X", "VQ1887": "X", "VQ1888": "X", "VQ1890": "X", "VQ3283": "X", "VQ3284": "X", "VQ3433": "X", "VQ3997": "X", "VQ4958": "X", "VQ7104": "X", "VQ7120": "X", "VQ7140": "X", "VQ7143": "X", "VQ7144": "X", "VQ7148": "X", "VQ7149": "X", "vq7151": "X", "VQ7154": "X", "VQ7156": "X", "VQ7620": "X", "VQ7623": "X", "VQ7661": "X", "VQ7670": "X", "VQ7683": "X", "VR0586": "X", "VR0590": "X", "VR0604": "X", "VR0611": "X", "VR0612": "X", "VR0613": "X", "VR0618": "X", "VR8891": "X", "VR8892": "X", "VR8893": "X", "VR8894": "X", "VR8895": "X", "VR8896": "X", "VR8897": "X", "VR8899": "X", "VR8900": "X", "VR8903": "X", "VR8904": "X", "VR9979": "X", "VS1596": "X", "VS2528": "X", "VS2529": "X", "VS2763": "X", "VS3288": "X", "VS3514": "X", "VS3812": "X", "VS3816": "X", "VS3819": "X", "VS4848": "X", "VS4850": "X", "VS4961": "X", "VS5303": "X", "VS5512": "X", "VS5760": "X", "VS5761": "X", "VS6681": "X", "VS6682": "X", "VS7248": "X", "VS7607": "X", "VS8064": "X", "VS8443": "X", "VS9642": "X", "VS9644": "X", "VT0190": "X", "vt4160": "X", "vt9236": "X", "vt9238": "X", "vt9239": "X", "vt9240": "X", "vt9840": "X", "vt9841": "X", "vu0418": "X", "vu0419": "X", "vu0420": "X", "vu0421": "X", "vu0730": "X", "vu1514": "X", "vu3145": "X", "vu4323": "X", "vu4324": "X", "vu7005": "X", "vu7470": "X", "vu8171": "X", "wi4366": "X", "WI5403": "X", "wi9880": "X", "wj0425": "X", "wj0471": "X", "wj1864": "X", "wj1865": "X", "WJ2221": "X", "wj2658": "X", "wj3422": "X", "WJ3472": "X", "WJ3878": "X", "WJ4396": "X", "WJ5089": "X", "WJ5110": "X", "WJ5405": "X", "WJ5649": "X", "WJ6183": "X", "WJ6727": "X", "WJ6728": "X", "WJ6836": "X", "WJ7068": "X", "WJ7223": "X", "WJ7398": "X", "WJ8232": "X", "WJ9049": "X", "WK1390": "X", "WK2497": "X", "WK2514": "X", "WK2530": "X", "WK2549": "X", "WK2568": "X", "WK2956": "X", "WK2980": "X", "WK4872": "X", "WK5156": "X", "WK7642": "X", "WK7650": "X", "WK7931": "X", "WK8066": "X", "WK8151": "X", "WK8626": "X", "WK9203": "X", "WK9204": "X", "WK9371": "X", "WL0571": "X", "WL0581": "X", "WL0806": "X", "WL1845": "X", "WL2414": "X", "WL2415": "X", "WL2416": "X", "WL2719": "X", "WL2720": "X", "WL2721": "X", "WL2918": "X", "WL3818": "X", "WL4094": "X", "WL4983": "X", "WL4984": "X", "WL5764": "X", "WM0605": "X", "WM0988": "X", "WM0989": "X", "WM1160": "X", "WM1607": "X", "WM2020": "X", "WM2021": "X", "WM2022": "X", "WM2023": "X", "WM2610": "X", "WM3350": "X", "WM3882": "X", "WM5052": "X", "WM5053": "X", "WM5056": "X", "WM5057": "X", "WM5058": "X", "WM5059": "X", "WM5060": "X", "WM5939": "X", "WM7571": "X", "WM7572": "X", "WM8221": "X", "WN0810": "X", "WN1690": "X", "WN1691": "X", "WN3416": "X", "WN4564": "X", "WN4565": "X", "WN4566": "X", "WN4567": "X", "WN4568": "X", "WN5154": "X", "WN5155": "X", "WN7402": "X", "wn8369": "X", "wn8657": "X", "wn9291": "X", "WO5083": "X", "WO5083": "X", "WO5085": "X", "WO6318": "X", "wo6319": "X", "WO6321": "X", "WO6322": "X", "WO7271": "X", "wo7492": "X", "WO7498": "X", "wo7621": "X", "WO8037": "X", "wo8038": "X", "WO8039": "X", "WP1541": "X", "wp1811": "X", "wp4065": "X", "WP4617": "X", "WP4640": "X", "WP5212": "X", "WP6339": "X", "wp6861": "X", "WP7679": "X", "WQ3124": "X", "wq3733": "X", "wq4416": "X", "wq4517": "X", "wq5179": "X", "wq5780": "X", "wq6059": "X", "wq6869": "X", "wq6870": "X", "wr1597": "X", "WR1598": "X", "wr2825": "X", "WR2925": "X", "wr3644": "X", "wr3859": "X", "WR4871": "X", "WR5165": "X", "WR7431": "X", "wr7798": "X", "wr7937": "X", "WR8462": "X", "ws2051": "X", "ws2052": "X", "ws2053": "X", "ws2390": "X", "ws2706": "X", "ws3433": "X", "ws3434": "X", "ws4134": "X", "WS4301": "X", "WS4302": "X", "WS4486": "X", "ws4704": "X", "ws6163": "X", "WS7094": "X", "WS9526": "X", "WS9527": "X", "WS9974": "X", "WT1340": "X", "WT2637": "X", "WT3541": "X", "WT3877": "X", "WT8528": "X", "WU0134": "X", "WU0672": "X", "WU1068": "X", "WU1927": "X", "WU1999": "X", "WU2265": "X", "WU2714": "X", "WU3874": "X", "WU4097": "X", "WU4290": "X", "WU6528": "X", "WU6529": "X", "WU7273": "X", "WU7481": "X", "WU8460": "X", "WU8461": "X", "WU8462": "X", "WU8463": "X", "WV1130": "X", "WV1131": "X", "WV1913": "X", "WV2751": "X", "WV2754": "X", "WV2758": "X", "WV2846": "X", "WV4012": "X", "WV4529": "X", "WV4886": "X", "WV9027": "X", "WV9029": "X", "WW1505": "X", "WW2052": "X", "WW2968": "X", "WW2969": "X", "WW3642": "X", "WW4332": "X", "WW4676": "X", "WW7601": "X", "WW7778": "X", "WW9351": "X", "WX0394": "X", "WX1105": "X", "WX3866": "X", "WX8985": "X", "WX9586": "X", "WY0482": "X", "WY2067": "X", "WY2068": "X", "WY4900": "X", "WY5565": "X", "WY6798": "X", "WY7820": "X", "WY7821": "X", "WY7889": "X", "WY8394": "X", "WY8396": "X", "WY8398": "X", "WZ0698": "X", "WZ1237": "X", "WZ3307": "X", "WZ3308": "X", "WZ3309": "X", "WZ3648": "X" };

function sleep(delay) {
	var start = new Date().getTime();
	while (new Date().getTime() < start + delay);
}

var count = 0;
var staples_inv = nlapiSearchRecord('invoice', null, [new nlobjSearchFilter('entity',null,'is',1006276), new nlobjSearchFilter('datecreated',null,'within','1/7/2014','1/7/2014')]);

var unique_staples = {};
for (var i = 0; i < staples_inv.length; i++){
	unique_staples[staples_inv[i].getId()] = 1;
}

console.log('FOUND: ' + Object.keys(unique_staples).length + ' invoices');

for (var id in unique_staples) {
	console.log(count++);
	if (count < 75){
		continue;
	}
	var invoice = nlapiLoadRecord('invoice', id);
	var numItems = 0;
	var itemsTotal = 0;
	var numFees = 0;
	var feesTotal = 0;

	for(var y in invoice.lineitems.item){
		if (typeof invoice.lineitems.item[y].item_display !=="undefined"){
			if(invoice.lineitems.item[y].item_display == "Staples Fees"){
				numFees++;
				feesTotal += parseFloat(invoice.lineitems.item[y].amount) ;
			} else {
				numItems++;
				itemsTotal += parseFloat(invoice.lineitems.item[y].amount) ;
			}
		}
	}

	if (numFees != numItems){
		var order = nlapiLoadRecord('salesorder', invoice.fields.createdfrom);
		if (nsp_orders[order.fields.custbody_amazon_order_id] == "X"){
			console.log( id + ' is an NSP Order: ' + order.fields.custbody_amazon_order_id);
		} else {
			var newFee = 0;
			for(var y in order.lineitems.item){
				if (order.lineitems.item[y].item_display == "Staples Fees"){
					newFee = parseFloat(order.lineitems.item[y].amount);
				}
			}
			console.log( id + ' Needs fee of: ' + newFee + ' [' + (itemsTotal * 0.35 * -1) + ']');
			var newItemId = numItems + numFees + 1;
			invoice.insertLineItem('item', newItemId);
			invoice.setLineItemValue('item', 'item', newItemId, 18359);
		    invoice.setLineItemValue('item', 'quantity', newItemId, 1);
		    invoice.setLineItemValue('item', 'amount', newItemId , newFee);
		    nlapiSubmitRecord(invoice);
		}
	} else {
		console.log( id + ' is cool.  Amount: ' + itemsTotal + '  Fees: ' + feesTotal + '  %: ' + (Math.abs(feesTotal)/itemsTotal*100));
	}
	sleep(500);
}